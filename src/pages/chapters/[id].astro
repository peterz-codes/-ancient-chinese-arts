---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { chapters } from '../../data/chapters';
import { chapterVideos } from '../../data/chapter_videos';
import contentData from '../../data/chapters_content.json';

export function getStaticPaths() {
  return chapters.map(ch => ({
    params: { id: String(ch.id) },
  }));
}

const { id } = Astro.params;
const chapterId = Number(id);
const chapter = chapters.find(c => c.id === chapterId)!;
const prev = chapters.find(c => c.id === chapterId - 1);
const next = chapters.find(c => c.id === chapterId + 1);
const bvid = chapterVideos[chapterId] ?? null;

const keywords = `${chapter.title},${chapter.category},房中术,道家养生,古代养生,中医养生,道家文化`;
const articleJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: chapter.title,
  description: chapter.summary,
  inLanguage: 'zh-CN',
  url: `https://www.zendao.tech/chapters/${chapterId}`,
  isPartOf: { '@type': 'Book', name: '古代房中术', url: 'https://www.zendao.tech' },
  position: chapterId,
};

// Get raw text content
const rawText: string = (contentData as Record<string, string>)[id] ?? '';
const lines = rawText.split('\n').map(l => l.trim()).filter(Boolean);
const contentLines = lines[0] && chapter.title.includes(lines[0].substring(0, 4))
  ? lines.slice(1)
  : lines;

// Group into paragraphs
const paragraphs: string[] = [];
let current = '';
for (const line of contentLines) {
  current += (current ? '　' : '') + line;
  if (/[。！？」』]$/.test(line) && current.length > 60) {
    paragraphs.push(current);
    current = '';
  }
}
if (current) paragraphs.push(current);
---

<BaseLayout
  title={`第${chapterId}篇 ${chapter.title}`}
  description={chapter.summary}
  keywords={keywords}
>
  <script type="application/ld+json" set:html={JSON.stringify(articleJsonLd)} slot="head" />
  <!-- Breadcrumb -->
  <div class="border-b border-border bg-paper-dark">
    <div class="max-w-4xl mx-auto px-6 py-3">
      <nav class="flex items-center gap-2 text-xs text-sepia tracking-wider">
        <a href="/" class="hover:text-vermil transition-colors">首页</a>
        <span class="text-border">›</span>
        <a href="/chapters" class="hover:text-vermil transition-colors">篇目</a>
        <span class="text-border">›</span>
        <span class="text-ink">{chapter.title}</span>
      </nav>
    </div>
  </div>

  <article class="max-w-4xl mx-auto px-6 py-12">

    <!-- Chapter header -->
    <header class="mb-10 pb-8 border-b border-border">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 border border-gold flex items-center justify-center shrink-0">
          <span class="text-gold text-sm font-semibold">{chapterId}</span>
        </div>
        <span class="text-xs text-sepia bg-paper-dark border border-border px-3 py-1 tracking-wider">
          {chapter.category}
        </span>
        <span class="text-xs text-sepia/60 tracking-wider">第 {chapter.page} 页</span>
      </div>
      <h1 class="text-3xl font-semibold text-ink tracking-wider mb-4 leading-snug">
        {chapter.title}
      </h1>
      <div class="border-l-2 border-gold pl-4 py-2 bg-paper-dark/50">
        <p class="text-sepia text-sm leading-relaxed italic">{chapter.summary}</p>
      </div>
    </header>

    <!-- Video Section -->
    <section class="mb-12">
      <div class="flex items-center gap-2 mb-3">
        <div class="w-1 h-4 bg-vermil"></div>
        <span class="text-sm text-ink font-semibold tracking-wider">数字人讲解</span>
      </div>

      {bvid ? (
        <div class="border border-border bg-ink" style="position:relative; padding-top:56.25%;">
          <iframe
            src={`https://player.bilibili.com/player.html?bvid=${bvid}&page=1&high_quality=1&danmaku=0&autoplay=0`}
            scrolling="no"
            frameborder="0"
            allowfullscreen
            style="position:absolute; top:0; left:0; width:100%; height:100%;"
          ></iframe>
        </div>
      ) : (
        <div class="border border-dashed border-border bg-paper-dark/40"
             style="position:relative; padding-top:56.25%;">
          <div style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;">
            <div class="w-14 h-14 border border-sepia/30 rounded-full flex items-center justify-center">
              <svg class="w-5 h-5 text-sepia/40 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
            <p class="text-sepia/40 text-xs tracking-widest">视频制作中，敬请期待</p>
          </div>
        </div>
      )}
    </section>

    <!-- Divider -->
    <div class="divider mb-10">
      <span class="text-gold text-xs tracking-widest px-4">原文</span>
    </div>

    <!-- Chapter content -->
    {paragraphs.length > 0 ? (
      <div class="space-y-5">
        {paragraphs.map((para, i) => (
          <p class="text-ink/90 leading-8 text-[0.95rem] tracking-wide"
             style={i === 0 ? '' : 'text-indent:2em'}>
            {para}
          </p>
        ))}
      </div>
    ) : (
      <div class="text-center py-16 text-sepia/60">
        <div class="text-4xl mb-4">❖</div>
        <p class="text-sm tracking-wider">本篇内容整理中</p>
      </div>
    )}

    <!-- Navigation -->
    <nav class="mt-16 pt-8 border-t border-border grid grid-cols-2 gap-4">
      {prev ? (
        <a href={`/chapters/${prev.id}`}
          class="group flex flex-col gap-1 p-4 border border-border hover:border-gold transition-colors">
          <span class="text-xs text-sepia/60 tracking-wider flex items-center gap-1">
            <span class="group-hover:-translate-x-1 transition-transform inline-block">←</span>
            上一篇
          </span>
          <span class="text-sm text-ink tracking-wider line-clamp-1 group-hover:text-vermil transition-colors">
            {prev.title}
          </span>
        </a>
      ) : <div />}

      {next ? (
        <a href={`/chapters/${next.id}`}
          class="group flex flex-col gap-1 p-4 border border-border hover:border-gold transition-colors text-right">
          <span class="text-xs text-sepia/60 tracking-wider flex items-center justify-end gap-1">
            下一篇
            <span class="group-hover:translate-x-1 transition-transform inline-block">→</span>
          </span>
          <span class="text-sm text-ink tracking-wider line-clamp-1 group-hover:text-vermil transition-colors">
            {next.title}
          </span>
        </a>
      ) : <div />}
    </nav>

    <div class="mt-6 text-center">
      <a href="/chapters"
        class="text-xs text-sepia hover:text-vermil transition-colors tracking-widest border-b border-transparent hover:border-vermil pb-0.5">
        返回篇目一览
      </a>
    </div>

  </article>
</BaseLayout>

<style>
  iframe { display: block; }
</style>
